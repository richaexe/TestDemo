#!/bin/bash

# Database credentials
DB_NAME="qaip_db"
DB_USER="qaipadmin"
BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +"%Y-%m-%d")

# Ensure the backup directory exists
mkdir -p "$BACKUP_DIR"

# Weekly Full Backup (Only on Sundays)
if [ $(date +%u) -eq 7 ]; then
    echo "Starting full backup for $DB_NAME on $DATE..." >> "$BACKUP_DIR/backup.log"
    pg_dump -U $DB_USER --no-password -F c -b -v -f "$BACKUP_DIR/full-$DATE.dump" $DB_NAME
fi

# Daily Incremental Backup (Only changed data)
echo "Starting incremental backup for $DB_NAME on $DATE..." >> "$BACKUP_DIR/backup.log"
pg_basebackup -D "$BACKUP_DIR/incremental-$DATE" -F tar -z -P --no-password -U $DB_USER

# Auto-delete old backups (older than 14 days)
find $BACKUP_DIR -type f -name "*.dump" -mtime +14 -exec rm {} \;
find $BACKUP_DIR -type d -name "incremental-*" -mtime +14 -exec rm -rf {} \;

# Log completion
echo "Backup completed on $DATE" >> "$BACKUP_DIR/backup.log"
